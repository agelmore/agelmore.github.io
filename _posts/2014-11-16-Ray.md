---
layout: post
title:  "Ray assembly"
date:   2014-11-16
comments: true
---

Onto the next assembler: Ray!

[Ray](http://denovoassembler.sourceforge.net/) is the assembler used in the CONCOCT paper, so I also tried to assemble the reads using this method. The method requires a Message Passing Interface (MPI) to run on multiple nodes. This is what makes this method superior as it can run in parallel and process huge read files. Unfortunately we don't have the ability to run MPI on multiple nodes on axiom, so I assembled using just one node.

I still have to use the MPI to get Ray to work, so I set it up in my account on axiom. When I tried to run mpiexec, I get the error message that I don't have a "local mpd" on my host. After googling mpd I deduced that it stands for Multithreaded, Parallel, and Distributed programming (as opposed to Multiple Personality Disorder, Milwaukee Police Department, or Meatpacking District). It converts my code into language recognizable by the MPI. 

The instructions on axiom have me create a file called .mpd.conf in my home (~) folder. In this file I had to make a secret word with the line `MPD_SECRETWORD = 1234`. I can then log into the local mpd with the commands `mpd &` or `mpdboot`. I think they're interchangeable. *P.S. Don't tell anyone what my secretword is.*

I then installed [Ray](http://sourceforge.net/projects/denovoassembler/files/) version 2.0.1 into /mnt/EXT/Schloss-data/amanda/ray. 

It was easy to install:

{% highlight bash %}

tar xjf Ray-2.0.1.tar.bz2
cd Ray-2.0.1
make PREFIX=build
make install
	
{% endhighlight %}	

Then I can run it from the ray-build directory.

```
mpiexec -n 1 ./Ray -k 32 -p /mnt/EXT/Schloss-data/amanda/Fuso/concoct/testdata/species/run1/All_R1.fasta /mnt/EXT/Schloss-data/amanda/Fuso/concoct/testdata/species/run1/All_R2.fasta -o /mnt/EXT/Schloss-data/amanda/Fuso/concoct/testdata/species/run1/ray
```
The assembly ran for 19 hours and then ran out of memory. It was able to make the graph with 10% of the reads.

resources_used.cput=00:00:08  
resources_used.mem=13408kb  
resources_used.vmem=398188kb  
resources_used.walltime=19:02:46  

Here is the tail of the logfile. It ran out of memory when it had read in 169400001 reads which is about 11%. 

{% highlight bash %}

Rank 0 is counting k-mers in sequence reads [169400001/1488000000]
Speed RAY_SLAVE_MODE_ADD_VERTICES 345 units/second
Estimated remaining time for this step: 44 days, 5 hours, 40 minutes, 28 seconds
Rank 0 has 815700000 vertices
Rank 0: assembler memory usage: 130538352 KiB
Critical exception: The system is out of memory, returned NULL.
Requested 3670016 bytes of type RAY_MALLOC_TYPE_DEFRAG_GROUP

{% endhighlight %}

I wonder if this would work if I did digital normalization first. I kind of had a feeling this wouldn't work since in the Alneburg paper they used 2048 nodes! 

###What's next

* Digital normalization
* Velvet assembler
* Compare assemblies
* CONCOCT pipeline

