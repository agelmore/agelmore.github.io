---
layout: post
title:  "More khmer"
date:   2014-11-19
comments: true
---

Trouble shooting with digital normalization.

Digital normalization finished with the new parameters (k=20, C=20). 

```
khmerEnv; python2.7 /mnt/EXT/Schloss-data/amanda/Fuso/khmer/khmerEnv/bin/normalize-by-median.py -C 20 -k 20 All.fa -o normalized
```

Logfile:

{% highlight bash %}

DONE with All.fa; kept 373177 of 1488000000 or  0%
output in normalized
fp rate estimated to be 1.000

{% endhighlight bash %}


But it still cut out a ton of reads! That can't be normal. I think there might be something wrong with the format of the file since I didn't use the khmer interleave script. I deleted the file using the velvet script and redid the interleaving.

{% highlight bash %}

khmerEnv
python2.7 /mnt/EXT/Schloss-data/amanda/Fuso/khmer/khmerEnv/bin/interleave-reads.py R1.test.txt R2.test.txt -o test.interleaved
python2.7 /mnt/EXT/Schloss-data/amanda/Fuso/khmer/khmerEnv/bin/normalize-by-median.py -C 20 -k 41 All.khmer.fasta -o All.khmer.normalized.fasta

{% endhighlight %}

Blarg, I got an error that the read names weren't correct. interleave-reads.py wants them to end with _R/1 and _R/2 but mine look like _R1 and _R2. Even more annoying, there are + and - symbols in the sequence names which don't always match up. Triple annoying is the fact that these sequence names are almost as long as the reads themselves! I decided to rename all the sequences with code names and create a key. This will make the data set a lot smaller and save time later. 

{% highlight python %}

from __future__ import print_function
import sys

fasta= open('All_R1.fasta','r')
codefasta= open('All_R1_codenames.fasta','wt')
code= open('All_R1_code', 'wt')

i=1

for line in fasta:
	if line.startswith('>'):
		print(">",i,"_R/1", sep="", file=codefasta)
		print(i,line.strip('>'), sep="\t", end="", file=code)
		i=i+1
	else:
		print(line, end="", file=codefasta)
	

fasta.close()
codefasta.close()
code.close()

{% endhighlight %}

After all the sequences are renamed, I ran the interleave script again and now it works! And I can do normalization on the interleaved file. 

{% highlight bash %}

khmerEnv
python2.7 /mnt/EXT/Schloss-data/amanda/Fuso/khmer/khmerEnv/bin/interleave-reads.py All_R1_codenames.fasta All_R2_codenames.fasta -o All_code_interleaved.fasta
python2.7 /mnt/EXT/Schloss-data/amanda/Fuso/khmer/khmerEnv/bin/normalize-by-median.py -C 20 -k 21 -p -x 1e9 All_code_interleaved.fasta -o All.code.normalized.fasta

{% endhighlight %}

Probably will take a while, this file is huge.

